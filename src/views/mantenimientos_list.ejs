<section class="card">
  <h1>Mantenimientos abiertos</h1>

  <table class="table">
    <thead>
      <tr>
        <th>ID</th><th>Placa</th><th>Cede</th><th>Tipo</th><th>Inicio</th><th>Operación</th>
      </tr>
    </thead>
    <tbody>
    <% (mants || []).forEach(m => { %>
      <tr>
        <td><%= m.id %></td>
        <td><a href="/historial/<%= m.placa %>"><%= m.placa %></a></td>
        <td><%= m.cedis_nombre || '-' %></td>
        <td><%= m.tipo %></td>
        <td><%= m.fecha_inicio ? dayjs(m.fecha_inicio).format('DD/MM/YYYY') : '-' %></td>
        <td>
          <button class="btn success" type="button" onclick="openCloseModal('<%= m.id %>')">✅ Se realizó</button>
        </td>
      </tr>
    <% }) %>
    </tbody>
  </table>

  <!-- Modals cerrar -->
  <% (mants || []).forEach(m => { %>
    <dialog id="closeDlg-<%= m.id %>" class="modal">
      <form method="post" action="/mantenimientos/<%= m.id %>/realizado" class="form modal-content">
        <h3>Cerrar mantenimiento — <%= m.placa %></h3>

        <fieldset class="checklist">
          <legend>¿Qué se le hizo?</legend>
          <% const opciones = [
            'Cambio de aceite',
            'Filtro de aire',
            'Pastillas/frenos',
            'Alineación/balanceo',
            'Rotación de llantas',
            'Líquidos (freno/refrigerante)',
            'Revisión general'
          ]; %>
          <div class="grid-2">
            <% opciones.forEach(op => { %>
              <label class="chk">
                <input type="checkbox" name="trabajos" value="<%= op %>"> <span><%= op %></span>
              </label>
            <% }); %>
          </div>
        </fieldset>

        <div id="sug-<%= m.id %>" class="muted" style="margin:.5rem 0;">Cargando sugerencias…</div>

        <label class="field">
          <span>Comentario (opcional)</span>
          <textarea name="comentario" rows="3" placeholder="Observaciones…"></textarea>
        </label>

        <div class="actions">
          <button type="submit" class="btn primary">Cerrar y reprogramar</button>
          <button type="button" class="btn" onclick="closeCloseModal('<%= m.id %>')">Cancelar</button>
        </div>
      </form>
    </dialog>
  <% }) %>
</section>
  </table>
</section>

<script>
  function openCloseModal(id) {
    const dlg = document.getElementById('closeDlg-' + id);
    if (dlg && dlg.showModal) dlg.showModal();
    // Sugerencias “IA”
    fetch('/api/ia/sugerencias/' + id)
      .then(r => r.json())
      .then(({ sugerencias }) => {
        const box = document.getElementById('sug-' + id);
        if (Array.isArray(sugerencias) && sugerencias.length) {
          box.innerHTML = 'Sugerido por IA: ' + sugerencias.join(', ');
          // Preseleccionar sugerencias
          sugerencias.forEach(s => {
            const input = dlg.querySelector('input[type=checkbox][value="'+s+'"]');
            if (input) input.checked = true;
          });
        } else {
          box.innerHTML = 'Sin sugerencias.';
        }
      })
      .catch(() => {
        const box = document.getElementById('sug-' + id);
        if (box) box.innerHTML = 'No se pudo obtener sugerencias.';
      });
  }
  function closeCloseModal(id) {
    const dlg = document.getElementById('closeDlg-' + id);
    if (dlg && dlg.close) dlg.close();
  }
</script>
