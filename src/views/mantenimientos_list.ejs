<% layout('partials/layout') %>

<section class="card">
  <div class="card-header" style="display:flex;gap:12px;align-items:flex-end;flex-wrap:wrap;justify-content:space-between">
    <h1 style="margin:0;">Mantenimientos abiertos</h1>

    <form method="get" class="row" style="display:flex;gap:10px;align-items:end;flex-wrap:wrap">
      <label class="field">
        <span>Mes</span>
        <input type="month" name="mes" value="<%= mes || dayjs().format('YYYY-MM') %>">
      </label>
      <label class="field">
        <span>Placa</span>
        <input type="text" name="placa" placeholder="Buscar placa‚Ä¶" value="<%= (placa||'') %>">
      </label>
      <button class="btn">Filtrar</button>
      <a href="/mantenimientos" class="btn ghost">Limpiar</a>
    </form>
  </div>

  <div class="table-responsive">
    <table class="table">
      <thead>
        <tr>
          <th>#</th>
          <th>Placa</th>
          <th>CEDIS</th>
          <th>Tipo</th>
          <th>Fecha programada</th>
          <th>Kilometraje</th>
          <th style="width:220px">Acciones</th>
        </tr>
      </thead>
      <tbody>
        <% if (!mants || mants.length===0) { %>
          <tr>
            <td colspan="7" style="text-align:center;opacity:.7;padding:24px">No hay mantenimientos abiertos en este mes.</td>
          </tr>
        <% } %>

        <% (mants||[]).forEach(m => { %>
          <tr>
            <td><%= m.id %></td>
            <td><a href="/historial/<%= m.placa %>"><strong><%= m.placa %></strong></a></td>
            <td><%= m.cedis_nombre || '‚Äî' %></td>
            <td><span class="badge orange"><%= m.tipo %></span></td>
            <td><%= m.fecha_inicio ? dayjs(m.fecha_inicio).format('DD/MM/YYYY') : '‚Äî' %></td>
            <td><%= m.km_al_entrar || '‚Äî' %></td>
            <td>
              <!-- Se realiz√≥ -> abre modal -->
              <button class="btn success"
                      data-open-realizado="1"
                      data-id="<%= m.id %>"
                      data-placa="<%= m.placa %>"
                      type="button">‚úÖ Se realiz√≥</button>

              <!-- Editar (si tienes vista) -->
              <!-- <a class="btn warning" href="/mantenimientos/<%= m.id %>/edit">‚úèÔ∏è Editar</a> -->

              <!-- Eliminar -->
              <form method="post" action="/mantenimientos/<%= m.id %>/delete" style="display:inline" onsubmit="return confirm('Eliminar mantenimiento <%= m.id %>?')">
                <button class="btn danger" type="submit">üóë Eliminar</button>
              </form>
            </td>
          </tr>
        <% }) %>
      </tbody>
    </table>
  </div>
</section>

<!-- Modal ‚ÄúSe realiz√≥‚Äù -->
<%- include('partials/modal_realizado') %>

<script>
// Modal b√°sico
(function(){
  const $modal = document.getElementById('modal-realizado');
  const $close = document.getElementById('modal-close');
  const $title = document.getElementById('modal-title');
  const $form  = document.getElementById('modal-form');
  const $id    = document.getElementById('modal-mant-id');
  const $placa = document.getElementById('modal-placa');
  const $reco  = document.getElementById('modal-recomendacion');

  // abre
  document.querySelectorAll('[data-open-realizado]').forEach(btn=>{
    btn.addEventListener('click', async ()=>{
      const id = btn.dataset.id;
      const placa = btn.dataset.placa;

      $id.value = id;
      $placa.textContent = placa || '‚Äî';
      $title.textContent = `Cerrar mantenimiento #${id}`;

      // Opcional: pedir recomendaci√≥n al backend seg√∫n el √∫ltimo mantenimiento
      try {
        const r = await fetch(`/api/ia/recomendar?mantId=${encodeURIComponent(id)}`);
        if (r.ok) {
          const data = await r.json();
          $reco.textContent = data?.recomendacion || '‚Äî';
        } else {
          $reco.textContent = '‚Äî';
        }
      } catch {
        $reco.textContent = '‚Äî';
      }

      $modal.classList.add('open');
    });
  });

  // cierra
  $close.addEventListener('click', ()=> $modal.classList.remove('open'));
  $modal.addEventListener('click', (e)=> {
    if (e.target === $modal) $modal.classList.remove('open');
  });

  // env√≠o
  $form.addEventListener('submit', ()=>{
    // el form ya hace POST a /mantenimientos/:id/realizado (action se arma din√°micamente)
    const id = $id.value;
    $form.action = `/mantenimientos/${encodeURIComponent(id)}/realizado`;
  });
})();
</script>
